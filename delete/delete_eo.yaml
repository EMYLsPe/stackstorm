version: '2.0'
name: bitesize.delete_eo
description: delete Environment Operator

workflows:
  main:
    type: direct
    input:
      - namespace
      - delete_names:
          limits : "guaranteed"
          secret_git_private_key: "git-private-key"
          secret_auth_token: "auth-token-file"
          ingress: "environment-operator"
          svc: "environment-operator"
          sa: "environment-operator"
          RBtoCR: "environment-operator"
          role: "environment-operator-namespace-access"
          RBtoRole: "environment-operator-namespace-access"
          deployment: "environment-operator"

    tasks:
       delete_eo_limits:
         action: kubernetes.k8saction
         input:
           api_group: CoreV1Api
           action_name: delete_namespaced_limit_range
           params:
             namespace: <% $.namespace %>
             name: <% $.delete_names.limits %>
             body: {}

       delete_k8s_secret_git_private_key:
         action: kubernetes.k8saction
         input:
           api_group: CoreV1Api
           action_name: delete_namespaced_secret
           params:
             namespace: <% $.namespace %>
             name: <% $.delete_names.secret_git_private_key %>
             body: {}

       delete_eo_auth-token-file:
         action: kubernetes.k8saction
         input:
           api_group: CoreV1Api
           action_name: delete_namespaced_secret
           params:
             namespace: <% $.namespace %>
             name: <% $.delete_names.secret_auth_token %>
             body: {}

       delete_eo_ingress:
         action: kubernetes.k8saction
         input:
           api_group: "ExtensionsV1beta1Api"
           action_name: "delete_namespaced_ingress"
           params:
             namespace: <% $.namespace %>
             name: <% $.delete_names.ingress %>
             body: {}

       delete_eo_svc:
         action: kubernetes.k8saction
         input:
           api_group: "CoreV1Api"
           action_name: "delete_namespaced_service"
           params:
             namespace: <% $.namespace %>
             name: <% $.delete_names.svc %>
             body: {}

       delete_eo_service_account:
         action: kubernetes.k8saction
         input:
           api_group: CoreV1Api
           action_name: delete_namespaced_service_account
           params:
             namespace: <% $.namespace %>
             name: <% $.delete_names.sa %>
             body: {}

       delete_eo_role_binding_to_clusterrole:
         action: kubernetes.k8saction
         input:
           api_group: RbacAuthorizationV1Api
           action_name: delete_namespaced_role_binding
           params:
             namespace: <% $.namespace %>
             name: <% $.delete_names.RBtoCR %>
             body: {}

       set_eo_istio_role_binding:
         action: bitesize.set_eo_istio_role_binding
         input:
           namespace: <% $.namespace %>
           istioRoleBinding: <% $.eo_istio_role_binding %>
           append: "false"
         publish:
           eo_istio_role_binding: <% task(set_eo_istio_role_binding).result.result %>

       remove_eo_istio_role_binding:
         action: kubernetes.k8saction
         input:
           api_group: RbacAuthorizationV1Api
           action_name: patch_namespaced_role_binding
           params:
             name: environment-operator
             namespace: istio-system
             body: <% $.eo_istio_role_binding %>

       delete_eo_role:
         action: kubernetes.k8saction
         input:
           api_group: RbacAuthorizationV1Api
           action_name: delete_namespaced_role
           params:
             namespace: <% $.namespace %>
             name: <% $.delete_names.role %>
             body: {}

       delete_eo_rolebinding_to_role:
         action: kubernetes.k8saction
         input:
           api_group: RbacAuthorizationV1Api
           action_name: delete_namespaced_role_binding
           params:
             namespace: <% $.namespace %>
             name: <% $.delete_names.RBtoRole %>
             body: {}

       delete_eo_deployment:
         action: kubernetes.k8saction
         input:
           api_group: "ExtensionsV1beta1Api"
           action_name: "delete_namespaced_deployment"
           params:
             namespace: <% $.namespace %>
             name: <% $.delete_names.deployment %>
             body: {}
         on-success:
           - succeed
